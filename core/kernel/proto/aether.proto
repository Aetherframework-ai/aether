syntax = "proto3";

package aether.v1;

// ========== Client API ==========
service ClientService {
  rpc StartWorkflow(StartWorkflowRequest) returns (StartWorkflowResponse);
  rpc GetWorkflowStatus(GetStatusRequest) returns (WorkflowStatus);
  rpc AwaitResult(AwaitResultRequest) returns (WorkflowResult);
  rpc CancelWorkflow(CancelRequest) returns (CancelResponse);
}

// ========== Worker API ==========
service WorkerService {
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc PollTasks(PollRequest) returns (stream Task);
  rpc CompleteStep(CompleteStepRequest) returns (CompleteStepResponse);
  rpc ReportStep(ReportStepRequest) returns (ReportStepResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
}

// ========== Resource Types ==========
enum ResourceType {
  STEP = 0;
  ACTIVITY = 1;
  WORKFLOW = 2;
}

message ResourceMetadata {
  int32 max_attempts = 1;
  int32 timeout = 2;
  string input_schema = 3;
  string output_schema = 4;
}

message ServiceResource {
  string name = 1;
  ResourceType type = 2;
  ResourceMetadata metadata = 3;
}

// ========== Admin API ==========
service AdminService {
  rpc ListWorkflows(ListRequest) returns (stream WorkflowInfo);
  rpc GetMetrics(GetMetricsRequest) returns (Metrics);
}

// ========== 核心消息 ==========
message StartWorkflowRequest {
  string workflow_type = 1;
  bytes input = 2;
}

message StartWorkflowResponse {
  string workflow_id = 1;
}

message GetStatusRequest {
  string workflow_id = 1;
}

message WorkflowStatus {
  string workflow_id = 1;
  State state = 2;
  string current_step = 3;
  bytes result = 4;
  string error = 5;
  int64 started_at = 6;
  int64 completed_at = 7;
}

enum State {
  PENDING = 0;
  RUNNING = 1;
  COMPLETED = 2;
  FAILED = 3;
  CANCELLED = 4;
}

message Task {
  string task_id = 1;
  string workflow_id = 2;
  string step_name = 3;
  string target_service = 4;
  string target_resource = 5;
  ResourceType resource_type = 6;
  bytes input = 7;
  RetryPolicy retry = 8;
  string workflow_type = 9;
}

message RetryPolicy {
  int32 max_attempts = 1;
  int32 initial_interval = 2;
  int32 backoff_multiplier = 3;
}

message CompleteStepRequest {
  string task_id = 1;
  bytes result = 2;
  string error = 3;
}

message CompleteStepResponse {
  bool success = 1;
}

// Step 状态报告
enum StepStatus {
  STEP_STARTED = 0;
  STEP_COMPLETED = 1;
  STEP_FAILED = 2;
}

message ReportStepRequest {
  string workflow_id = 1;
  string step_name = 2;
  StepStatus status = 3;
  bytes input = 4;   // 仅 STEP_STARTED 时使用
  bytes output = 5;  // 仅 STEP_COMPLETED 时使用
  string error = 6;  // 仅 STEP_FAILED 时使用
}

message ReportStepResponse {
  bool success = 1;
}

message RegisterRequest {
  string worker_id = 1;
  string service_name = 2;
  string group = 3;
  repeated string language = 4;
  repeated ServiceResource provides = 5;
}

message RegisterResponse {
  string server_id = 1;
  repeated string supported_workflow_types = 2;
}

message PollRequest {
  string worker_id = 1;
  int32 max_tasks = 2;
}

message HeartbeatRequest {
  string task_id = 1;
}

message HeartbeatResponse {
  bool ok = 1;
}

message WorkflowResult {
  bytes result = 1;
  string error = 2;
  State state = 3;
}

message CancelRequest {
  string workflow_id = 1;
}

message CancelResponse {
  bool success = 1;
}

message ListRequest {
  string workflow_type = 1;
  State state = 2;
}

message WorkflowInfo {
  string workflow_id = 1;
  string workflow_type = 2;
  State state = 3;
  int64 started_at = 4;
  int64 completed_at = 5;
}

message GetMetricsRequest {}

message Metrics {
  int64 active_workflows = 1;
  int64 completed_workflows = 2;
  int64 failed_workflows = 3;
}

message AwaitResultRequest {
  string workflow_id = 1;
  int32 timeout_seconds = 2;
}
